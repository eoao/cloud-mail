name: ğŸš€ Deploy cloud-mail to Cloudflare Workers

on:
  push:
    branches: [ main ]
    paths:
      - "mail-worker/**"
      - "mail-vue/**"
  workflow_dispatch:

jobs:
  Deploy-cloud-mail:
    name: ğŸ—ï¸ Build and Deploy
    runs-on: ubuntu-latest

    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      D1_DATABASE_ID: ${{ secrets.D1_DATABASE_ID }}
      KV_NAMESPACE_ID: ${{ secrets.KV_NAMESPACE_ID }}
      R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
      DOMAIN: ${{ secrets.DOMAIN }}
      ADMIN: ${{ secrets.ADMIN }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      ENCRYPTION_SECRET: ${{ secrets.ENCRYPTION_SECRET }}
      INIT_URL: ${{ secrets.INIT_URL }}
    
    steps:
      - name: â¡ï¸ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "./mail-worker/package-lock.json"

      - name: ğŸ“¥ Install dependencies
        run: npm ci
        working-directory: ./mail-worker

      - name: ğŸ“¡ Disable wrangler telemetry
        run: npx wrangler telemetry disable -c wrangler-action.toml
        working-directory: ./mail-worker

      - name: ğŸ¤« Set Worker secrets (ignore if already exists)
        working-directory: ./mail-worker
        run: |
          WORKER_NAME="cloud-mail"
          echo "ğŸ”’ Attempting to create/update secrets. Existing secrets will be ignored."
          for VAR in DOMAIN ADMIN JWT_SECRET ENCRYPTION_SECRET; do
            if [ -n "${!VAR}" ]; then
              VAR_LOWER=$(echo "$VAR" | tr '[:upper:]' '[:lower:]')
              echo ">> Processing secret: '$VAR_LOWER'"
              (echo "${!VAR}" | npx wrangler secret put "$VAR_LOWER" --name "$WORKER_NAME") || true
            else
              echo "âš ï¸ Warning: GitHub Secret '$VAR' is not set. Skipping."
            fi
          done
          
          echo "âœ¨ Secret processing complete."

      - name: ğŸ› ï¸ Prepare Config and Deploy
        working-directory: ./mail-worker
        run: |
          echo "âš™ï¸ Dynamically updating wrangler.toml with binding IDs..."
          sed -i "s|\${D1_DATABASE_ID}|${D1_DATABASE_ID}|g" wrangler.toml
          sed -i "s|\${KV_NAMESPACE_ID}|${KV_NAMESPACE_ID}|g" wrangler.toml
          sed -i "s|\${R2_BUCKET_NAME}|${R2_BUCKET_NAME}|g" wrangler.toml
          echo "ğŸš€ Configuration updated. Starting deployment..."
          npx wrangler deploy | grep -v "https://.*\.workers\.dev" || true
          echo "âœ… Deployment command executed."

      - name: ğŸ—„ï¸ Initialize Database (if INIT_URL is set)
        run: |
          if [ -z "$INIT_URL" ]; then
            echo "âœ… Deployment successful. INIT_URL not set, skipping initialization."
            exit 0
          fi
          
          echo "â³ Waiting 10 seconds before checking initialization status..."
          sleep 10
          
          HTTP_CODE=$(curl -s -w "%{http_code}" -o response.txt "$INIT_URL")
          RESPONSE_BODY=$(cat response.txt)
          
          echo "ğŸ” Checking response... (Status: $HTTP_CODE)"

          if [ "$HTTP_CODE" = "200" ] && [ "$RESPONSE_BODY" = "åˆå§‹åŒ–æˆåŠŸ" ]; then
            echo "ğŸ‰âœ… Fresh initialization successful!"
          elif [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Database is already initialized or in a stable state. Response: $RESPONSE_BODY"
          else
            echo "âš ï¸ Database initialization check failed with HTTP status: $HTTP_CODE. Please check your worker logs."
          fi

      - name: ğŸ“£ Notify Final Status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ğŸ‰ğŸ‰ğŸ‰ Hooray! Deployment completed successfully! ğŸ‰ğŸ‰ğŸ‰"
          else
            echo "âŒâŒâŒ Oh no! The deployment failed. Please check the logs above for errors. âŒâŒâŒ"
          fi
          
      - name: Delete workflow runs
        uses: GitRML/delete-workflow-runs@main
        with:
          retain_days: '3'
          keep_minimum_runs: '0'